package Server;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

import logic.Account;

/**
 * BiteMe
 *
 * <p>
 * No description provided (generated by Swagger Codegen
 * https://github.com/swagger-api/swagger-codegen)
 *
 */
public class AccountApiService {
	/**
	 * Create Account
	 *
	 * This can only be done by the logged in Account.
	 *
	 */
	public static void createAccount(Account account, Response response) {
		try {
			PreparedStatement postAccount = EchoServer.con.prepareStatement(
					"INSERT INTO biteme.account (UserID, UserName,FirstName, LastName, PhoneNumber, Email,"
							+ " W4C, Type, status, branchManagerID, Area, isLoggedIn, isBusiness)"
							+ " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?);SELECT last_insert_id();");
			postAccount.setInt(1, account.getUserID());
			// Its the first userName that he had so the test is in users table on login
			postAccount.setString(2, account.getUserName());
			postAccount.setString(3, account.getFirstName());
			postAccount.setString(4, account.getLastName());
			postAccount.setString(5, account.getPhone());
			postAccount.setString(6, account.getEmail());
			postAccount.setString(7, account.getW4c_code());
			postAccount.setString(8, account.getType());
			postAccount.setString(9, account.getStatus());
			postAccount.setInt(10, account.getBranch_manager_ID());
			postAccount.setString(11, account.getArea());
			// isLoggedIn
			postAccount.setBoolean(12, false);
			postAccount.setBoolean(13, account.isBusiness());
			postAccount.execute();
		} catch (SQLException e) {
			if (e.getErrorCode() == 1062) {
				response.setCode(404);
				response.setDescription("User id already exist");
			} else {
				response.setCode(400);
				response.setDescription("Fields are missing");
			}
			return;
		}
		response.setCode(200);
		response.setDescription("Success in registering" + account.getUserID());
		response.setBody(null);
	}

	/**
	 * Delete Account
	 *
	 * This can only be done by the logged in Account.
	 *
	 */
	public static void deleteAccount(String userName, int userID, int branchManagerID, Response response) {
		Account account = null;
		try {
			PreparedStatement deleteAccount = EchoServer.con.prepareStatement(
					"DELETE FROM accounts biteme.account WHERE accounts.UserName = ? and accounts.UserID = ? and accounts.BranchManagerID = ?;");
			deleteAccount.setString(1, userName);
			// Its the first userName that he had so the test is in users table on login
			deleteAccount.setInt(2, userID);
			deleteAccount.setInt(3, branchManagerID);
			deleteAccount.execute();
			deleteAccount.getResultSet();
		} catch (SQLException e) {}
		response.setCode(200);
		response.setDescription("Success in deleting account " + userID);
		response.setBody(null);
	}

	/**
	 * Get all Accounts
	 *
	 */
	public static void getAllAccounts(int branch_manager_id, Response response) {
		ResultSet rs;
		Account account = null;
		ArrayList<Account> acccounts = new ArrayList<>();
		try {
			PreparedStatement loginAccount = EchoServer.con
					.prepareStatement("SELECT * FROM accounts biteme.account WHERE branchManagerID = ?;");
			loginAccount.setInt(1, branch_manager_id);
			rs = loginAccount.getResultSet();
			while (rs.next()) {
				account = new Account(rs.getInt(finals.ACCOUNT_USER_ID), rs.getString(finals.ACCOUNT_USER_NAME),
						rs.getString(finals.ACCOUNT_FIRST_NAME), rs.getString(finals.ACCOUNT_LAST_NAME),
						rs.getString(finals.ACCOUNT_EMAIL), rs.getString(finals.ACCOUNT_TYPE),
						rs.getString(finals.ACCOUNT_PHONE), rs.getBoolean(finals.ACCOUNT_IS_BUSINESS),
						rs.getString(finals.ACCOUNT_STATUS), rs.getString(finals.ACCOUNT_W4C_CODE),
						rs.getInt(finals.ACCOUNT_BRANCH_MANAGER_ID), rs.getString(finals.ACCOUNT_AREA),
						rs.getInt(finals.ACCOUNT_DEBT));
				acccounts.add(account);
			}
		} catch (SQLException e1) {
		}

		response.setCode(200);
		response.setDescription("Success in fetching accounts " + account.getUserID());
		response.setBody(account);
	}

	/**
	 * Get Account by Account name
	 *
	 */
	public static void getAccount(String userName, int userID, int branchManagerID, Response response) {
		ResultSet rs;
		Account account = null;
		try {
			PreparedStatement getAccount = EchoServer.con.prepareStatement(
					"SELECT * FROM accounts biteme.account WHERE accounts.UserName = ? and accounts.UserID = ? and accounts.BranchManagerID = ?;");
			getAccount.setString(1, userName);
			// Its the first userName that he had so the test is in users table on login
			getAccount.setInt(2, userID);
			getAccount.setInt(3, branchManagerID);
			getAccount.execute();
			rs = getAccount.getResultSet();
			account = new Account(rs.getInt(finals.ACCOUNT_USER_ID), rs.getString(finals.ACCOUNT_USER_NAME),
					rs.getString(finals.ACCOUNT_FIRST_NAME), rs.getString(finals.ACCOUNT_LAST_NAME),
					rs.getString(finals.ACCOUNT_EMAIL), rs.getString(finals.ACCOUNT_TYPE),
					rs.getString(finals.ACCOUNT_PHONE), rs.getBoolean(finals.ACCOUNT_IS_BUSINESS),
					rs.getString(finals.ACCOUNT_STATUS), rs.getString(finals.ACCOUNT_W4C_CODE),
					rs.getInt(finals.ACCOUNT_BRANCH_MANAGER_ID), rs.getString(finals.ACCOUNT_AREA),
					rs.getInt(finals.ACCOUNT_DEBT));
		} catch (SQLException e) {}
		response.setCode(200);
		response.setDescription("Success in fetching account " + account.getUserID());
		response.setBody(account);
	}

	/**
	 * Logs Account into the system
	 *
	 */
	public static void loginAccount(String userName, String password, Response response) {
		ResultSet rs;
		Account account = null;
		try {
			PreparedStatement loginAccount = EchoServer.con.prepareStatement(
					"SELECT users.isLoggedIn FROM users biteme.users WHERE users.UserName = ? and users.Password = ?;"
							+ "UPDATE biteme.users AS users SET isLoggedIn = 1 WHERE users.UserName = ? and users.Password = ?;");
			loginAccount.setString(1, userName);
			// Its the first userName that he had so the test is in users table on login
			loginAccount.setString(2, password);
			loginAccount.execute();
			rs = loginAccount.getResultSet();
			if (rs.getBoolean(1)) {
				throw new SQLException("User is already logged in", "400", 400);
			} else if (rs.getFetchSize() == 0) {
				throw new SQLException("User isn't exist");
			}
		} catch (SQLException e) {
			if (e.getErrorCode() == 400) {
				response.setCode(400);
				response.setDescription(e.getMessage());
			} else {
				response.setCode(404);
				response.setDescription(e.getMessage());
			}
			try {
				PreparedStatement loginAccount = EchoServer.con
						.prepareStatement("SELECT * FROM accounts biteme.account WHERE accounts.UserName = ?;");
				rs = loginAccount.getResultSet();
				account = new Account(rs.getInt(finals.ACCOUNT_USER_ID), rs.getString(finals.ACCOUNT_USER_NAME),
						rs.getString(finals.ACCOUNT_FIRST_NAME), rs.getString(finals.ACCOUNT_LAST_NAME),
						rs.getString(finals.ACCOUNT_EMAIL), rs.getString(finals.ACCOUNT_TYPE),
						rs.getString(finals.ACCOUNT_PHONE), rs.getBoolean(finals.ACCOUNT_IS_BUSINESS),
						rs.getString(finals.ACCOUNT_STATUS), rs.getString(finals.ACCOUNT_W4C_CODE),
						rs.getInt(finals.ACCOUNT_BRANCH_MANAGER_ID), rs.getString(finals.ACCOUNT_AREA),
						rs.getInt(finals.ACCOUNT_DEBT));
				if (account.getStatus().equals("blocked")) {
					throw new SQLException("Account" + account.getUserID() + "is blocked", "400", 401);
				}
			} catch (SQLException e1) {
				if (e1.getErrorCode() == 401) {
					response.setCode(401);
					response.setDescription(e.getMessage());
					response.setBody(null);
				}
			}
			response.setCode(200);
			response.setDescription("Success in login " + account.getUserID());
			response.setBody(account);
		}
	}

	/**
	 * Logs out current logged in Account session
	 *
	 */
	public static void logoutAccount(String userName, Response response) {
		ResultSet rs;
		try {
			PreparedStatement logOutAccount = EchoServer.con
					.prepareStatement("UPDATE biteme.users AS users SET isLoggedIn = 0 WHERE users.UserName = ?;");
			logOutAccount.setString(1, userName);
			logOutAccount.execute();
			rs = logOutAccount.getResultSet();
			if (rs.rowUpdated() == false) {
				throw new SQLException("couldn't log out");
			}
		} catch (SQLException e) {
			response.setCode(400);
			response.setDescription(e.getMessage());
			response.setBody(null);
		}
		response.setCode(200);
		response.setDescription("Success in logging out");
		response.setBody(null);
	}

	/**
	 * Updated Account
	 *
	 * This can only be done by the logged in Account.
	 *
	 */
	public static void updateAccount(Account account, Response response) {
		try {
			PreparedStatement postAccount = EchoServer.con.prepareStatement(
					"UPDATE biteme.account AS account SET (UserID = ?, UserName = ?,FirstName = ?, LastName = ?, PhoneNumber = ?, Email = ?,"
							+ " W4C = ?, Type = ?, status = ?, branchManagerID = ?, Area = ?, isLoggedIn = ?, isBusiness = ?)"
							+ "WHERE account.UserID = ? and account.UserName = ? and account.branchManagerID = ?");
			postAccount.setInt(1, account.getUserID());
			// Its the first userName that he had so the test is in users table on login
			postAccount.setString(2, account.getUserName());
			postAccount.setString(3, account.getFirstName());
			postAccount.setString(4, account.getLastName());
			postAccount.setString(5, account.getPhone());
			postAccount.setString(6, account.getEmail());
			postAccount.setString(7, account.getW4c_code());
			postAccount.setString(8, account.getType());
			postAccount.setString(9, account.getStatus());
			postAccount.setInt(10, account.getBranch_manager_ID());
			postAccount.setString(11, account.getArea());
			// isLoggedIn
			postAccount.setBoolean(12, false);
			postAccount.setBoolean(13, account.isBusiness());
			postAccount.setInt(14, account.getUserID());
			postAccount.setString(14, account.getUserName());
			postAccount.setInt(15, account.getBranch_manager_ID());

			postAccount.execute();
		} catch (SQLException e) {
		} finally {
			response.setCode(200);
			response.setDescription("Success in updating account" + account.getUserID());
			response.setBody(null);
		}
	}
}
